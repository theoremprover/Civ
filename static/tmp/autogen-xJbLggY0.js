$(function(){$(".Debug-Draggable").draggable();$(".Debug-Droppable").droppable({drop:function(event,ui){alert($(ui.draggable).html())}});$(".PlayerArea-CityItem").draggable();$(".Map-SquareContainer").droppable({accept:".PlayerArea-CityItem",drop:function(event,ui){var source=$(ui.draggable).data("source");console.log("source=%s",JSON.stringify(source));var target=$(this).data("target");console.log("target=%s",JSON.stringify(target));var move=[source,target];console.log("move.toSource()=%s",move.toSource());console.log("JSON.stringify(move)=%s",JSON.stringify(move));var found=0;for(i=0;i<allowedMoves.length;i++)if(JSON.stringify(allowedMoves[i])==JSON.stringify(move)){found=1;break};if(!found){alert("This move is not allowed!")}else{var action={"tag":"GameActionA","contents":[source,target]},actionstr=JSON.stringify(action);$("#Debug-Action").html(action);sendAction(actionstr)}}});$("#Debug-Send").click(function(){var action=$("textarea#Debug-Action").val();sendAction(action)});$(".Debug-DragCity").mousedown(function(e){var clone=$(this).clone();console.log("town: %o",$(this));console.log("clone: %o",clone);clone.draggable({cursor:'move',start:function(event,ui){ui.helper.css('transform','rotate(0deg) scale(1)')},stop:function(event,ui){ui.helper.css('transform','rotate(0deg) scale(1)')}});clone.addClass("PlayerArea-CityItem");clone.appendTo(".Debug");clone.trigger(e);clone.css({position:"absolute",left:e.pageX,top:e.pageY})})})
function sendAction(action_str){sendAction_Fun(action_str,function(){})}
function sendAction_Fun(action_str,fun_after_response){xh=new XMLHttpRequest();xh.open("POST",'http://dev.civ:3000/command',true);xh.setRequestHeader("Content-type","application/json");xh.onreadystatechange=function(){if(xh.readyState==XMLHttpRequest.DONE)if(xh.status==200){var response=JSON.parse(xh.responseText);if(response.hasOwnProperty("Left")){alert(response["Left"])}else fun_after_response()}else{document.write(xh.responseText);document.close()}};xh.ontimeout=function(){alert("Timeout sending "+action_str)};xh.onerror=function(){alert("Error sending "+action_str)};xh.send(action_str)};xmlhttp=new XMLHttpRequest()
function longPoll(){xmlhttp.open("POST",'http://dev.civ:3000/game/test',true);xmlhttp.timeout=1000*60*10;xmlhttp.setRequestHeader("Content-type","application/json");xmlhttp.onreadystatechange=function(){if(xmlhttp.readyState==XMLHttpRequest.DONE)if(xmlhttp.status==200){document.write(xmlhttp.responseText);document.close()}};xmlhttp.ontimeout=function(){longPoll()};xmlhttp.onerror=function(){longPoll()};xmlhttp.send("{\"tag\":\"GameGame\",\"contents\":\"test\"}")}
function redirectTo(target_str){xmlhttp.open("GET",target_str,true);xmlhttp.onreadystatechange=function(){if(xmlhttp.readyState==XMLHttpRequest.DONE)if(xmlhttp.status==200){document.write(xmlhttp.responseText);document.close()}};xmlhttp.ontimeout=function(){alert("Timeout loading "+target_str)};xmlhttp.onerror=function(){alert("Error loading "+target_str)};xmlhttp.send(null)}
function sendAndRedirect(action_str,url){sendAction_Fun(action_str,function(){redirectTo(url)})}
function onUnload(){xmlhttp.abort()};var allowedMoves=[[{"tag":"CitySource","contents":"New Player"},{"tag":"BuildFirstCityTarget","contents":["New Player",{"yCoor":1,"xCoor":1}]}],[{"tag":"CitySource","contents":"New Player"},{"tag":"BuildFirstCityTarget","contents":["New Player",{"yCoor":2,"xCoor":1}]}],[{"tag":"CitySource","contents":"New Player"},{"tag":"BuildFirstCityTarget","contents":["New Player",{"yCoor":1,"xCoor":2}]}],[{"tag":"CitySource","contents":"New Player"},{"tag":"BuildFirstCityTarget","contents":["New Player",{"yCoor":2,"xCoor":2}]}]]